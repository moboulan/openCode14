name: Web UI CI/CD

on:
  push:
    branches: [master]
    paths:
      - 'web-ui/**'
      - '.github/workflows/web-ui-ci.yml'
  pull_request:
    paths:
      - 'web-ui/**'
      - '.github/workflows/web-ui-ci.yml'
  workflow_dispatch:

env:
  SERVICE_DIR: web-ui
  IMAGE_NAME: expertmind-web-ui

jobs:
  # ──────────────────────────────────────────
  # Stage 1: Code Quality (Lint)
  # ──────────────────────────────────────────
  lint:
    name: "Stage 1: Code Quality"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd ${{ env.SERVICE_DIR }}
          npm ci

      - name: Build check
        run: |
          cd ${{ env.SERVICE_DIR }}
          npm run build

      - name: Check code duplication
        run: |
          npx jscpd ${{ env.SERVICE_DIR }}/src --threshold 3 --reporters console || true

  # ──────────────────────────────────────────
  # Stage 2: Security Scanning
  # ──────────────────────────────────────────
  security:
    name: "Stage 2: Security Scanning"
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  # ──────────────────────────────────────────
  # Stage 3: Build Docker Image
  # ──────────────────────────────────────────
  build:
    name: "Stage 3: Build"
    runs-on: ubuntu-latest
    needs: security
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.SERVICE_DIR }}
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Print image size
        run: docker images ${{ env.IMAGE_NAME }} --format "{{.Repository}}:{{.Tag}} — {{.Size}}"

  # ──────────────────────────────────────────
  # Stage 4: Vulnerability Scan
  # ──────────────────────────────────────────
  scan:
    name: "Stage 4: Trivy Scan"
    runs-on: ubuntu-latest
    needs: build
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Build image for scanning
        run: |
          cd ${{ env.SERVICE_DIR }}
          docker build -t ${{ env.IMAGE_NAME }}:scan .

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "${{ env.IMAGE_NAME }}:scan"
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: Run Trivy (SARIF report)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "${{ env.IMAGE_NAME }}:scan"
          format: "sarif"
          output: "trivy.sarif"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true

      - name: Upload Trivy SARIF report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif-web-ui
          path: "trivy.sarif"
          retention-days: 30

  # ──────────────────────────────────────────
  # Stage 5+6+7: Deploy & Verify
  # ──────────────────────────────────────────
  deploy-verify:
    name: "Stage 5+6+7: Deploy & Smoke Test"
    runs-on: ubuntu-latest
    needs: [build, scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    env:
      IMAGE_NAME: expertmind-web-ui
    steps:
      - uses: actions/checkout@v4

      - name: Tag current images as :prev for rollback
        run: |
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:prev 2>/dev/null || echo "No existing image to tag"

      - name: Deploy with Docker Compose
        run: |
          docker compose down -v --remove-orphans 2>/dev/null || true
          docker compose up -d --build
          echo "Waiting for services to start..."

      - name: Wait for Web UI to be healthy
        run: |
          TIMEOUT=90; ELAPSED=0
          until curl -sf http://localhost:8080/health > /dev/null 2>&1; do
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "Web UI health check failed after ${TIMEOUT}s"
              docker compose logs web-ui
              exit 1
            fi
            echo "Waiting... (${ELAPSED}/${TIMEOUT}s)"
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          echo "Web UI is healthy"

      - name: Verify health endpoint
        run: |
          echo "--- /health ---"
          curl -sf http://localhost:8080/health | jq .

      - name: Smoke test — Serve index.html
        run: |
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/)
          [ "$HTTP_CODE" = "200" ] && echo "200 OK — index.html served" || (echo "Got $HTTP_CODE" && exit 1)

      - name: Smoke test — SPA fallback
        run: |
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/oncall)
          [ "$HTTP_CODE" = "200" ] && echo "200 OK — SPA fallback works" || (echo "Got $HTTP_CODE" && exit 1)

      - name: Smoke test — Static assets
        run: |
          # Verify built JS/CSS assets are present
          curl -sf http://localhost:8080/ | grep -q 'assets/' && echo "Asset references found in HTML" || (echo "No asset references" && exit 1)

      - name: Rollback on failure
        if: failure()
        run: |
          echo "FAIL Verification failed -- attempting rollback to :prev"
          docker tag ${{ env.IMAGE_NAME }}:prev ${{ env.IMAGE_NAME }}:latest 2>/dev/null || echo "No :prev image found"
          docker compose down -v --remove-orphans 2>/dev/null || true
          docker compose up -d
          sleep 20
          curl -sf http://localhost:8080/health | jq . || echo "WARN Service not healthy after rollback"

      - name: Dump logs on failure
        if: failure()
        run: docker compose logs --tail=50

      - name: Teardown
        if: always()
        run: docker compose down -v --remove-orphans 2>/dev/null || true
