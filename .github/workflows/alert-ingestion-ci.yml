name: Alert Ingestion CI/CD

on:
  push:
    branches: [master]
    paths:
      - 'alert-ingestion-service/**'
  pull_request:
    paths:
      - 'alert-ingestion-service/**'
  workflow_dispatch:

env:
  SERVICE_DIR: alert-ingestion-service
  IMAGE_NAME: expertmind-alert-ingestion

jobs:
  # ──────────────────────────────────────────
  # Stage 1: Code Quality
  # ──────────────────────────────────────────
  lint:
    name: "Stage 1: Code Quality"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linting tools
        run: pip install flake8 pylint black isort

      - name: Install service dependencies
        run: pip install -r ${{ env.SERVICE_DIR }}/requirements.txt

      - name: Run flake8
        run: |
          cd ${{ env.SERVICE_DIR }}
          flake8 app/ --max-line-length=120 --ignore=E501,W503,E402 --statistics

      - name: Run pylint
        run: |
          cd ${{ env.SERVICE_DIR }}
          pylint app/ --disable=C0114,C0115,C0116,R0903 --fail-under=7.0

      - name: Check formatting (black)
        run: |
          cd ${{ env.SERVICE_DIR }}
          black --check --line-length=120 app/

      - name: Check import order (isort)
        run: |
          cd ${{ env.SERVICE_DIR }}
          isort --check --profile=black app/

  # ──────────────────────────────────────────
  # Stage 2: Security Scanning
  # ──────────────────────────────────────────
  security:
    name: "Stage 2: Security Scanning"
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────────────────
  # Stage 3: Build Docker Image
  # ──────────────────────────────────────────
  build:
    name: "Stage 3: Build"
    runs-on: ubuntu-latest
    needs: security
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.SERVICE_DIR }}
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}

      - name: Print image size
        run: docker images ${{ env.IMAGE_NAME }} --format "{{.Repository}}:{{.Tag}} — {{.Size}}"

  # ──────────────────────────────────────────
  # Stage 4: Vulnerability Scan
  # ──────────────────────────────────────────
  scan:
    name: "Stage 4: Trivy Scan"
    runs-on: ubuntu-latest
    needs: build
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Build image for scanning
        run: |
          cd ${{ env.SERVICE_DIR }}
          docker build -t ${{ env.IMAGE_NAME }}:scan .

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.IMAGE_NAME }}:scan"
          format: "table"
          exit-code: "1"
          severity: "CRITICAL"
          ignore-unfixed: true

      - name: Run Trivy (SARIF report)
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.IMAGE_NAME }}:scan"
          format: "sarif"
          output: "trivy.sarif"
          severity: "HIGH,CRITICAL"

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy.sarif"

  # ──────────────────────────────────────────
  # Stage 5: Tests
  # ──────────────────────────────────────────
  test:
    name: "Stage 5: Tests"
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: hackathon2026
          POSTGRES_DB: incident_platform
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd ${{ env.SERVICE_DIR }}
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Initialize database schemas
        env:
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: hackathon2026
          PGDATABASE: incident_platform
        run: |
          psql -f database/init-db/01-init-database.sql

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://postgres:hackathon2026@localhost:5432/incident_platform
          INCIDENT_SERVICE_URL: http://localhost:8002
          NOTIFICATION_SERVICE_URL: http://localhost:8004
        run: |
          cd ${{ env.SERVICE_DIR }}
          python -m pytest tests/ -v \
            --tb=short \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-fail-under=60

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-alert-ingestion
          path: ${{ env.SERVICE_DIR }}/htmlcov/
          retention-days: 7

  # ──────────────────────────────────────────
  # Stage 6: Deploy
  # ──────────────────────────────────────────
  deploy:
    name: "Stage 6: Deploy"
    runs-on: ubuntu-latest
    needs: [build, test, scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Tag current images as :prev (rollback)
        run: |
          for svc in alert-ingestion incident-management oncall-service notification-service web-ui; do
            docker tag expertmind-${svc}:latest expertmind-${svc}:prev 2>/dev/null || true
          done

      - name: Deploy with Docker Compose
        run: |
          docker compose down -v --remove-orphans 2>/dev/null || true
          docker compose up -d --build
          echo "Waiting 30s for services to start..."
          sleep 30

  # ──────────────────────────────────────────
  # Stage 7: Verify & Smoke Test
  # ──────────────────────────────────────────
  verify:
    name: "Stage 7: Verify"
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Wait for Alert Ingestion to be healthy
        run: |
          TIMEOUT=60; ELAPSED=0
          until curl -sf http://localhost:8001/health > /dev/null 2>&1; do
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "Health check failed after ${TIMEOUT}s"
              exit 1
            fi
            echo "Waiting... (${ELAPSED}/${TIMEOUT}s)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          echo "Alert Ingestion is healthy"

      - name: Verify health endpoints
        run: |
          echo "--- /health ---"
          curl -sf http://localhost:8001/health | jq .
          echo "--- /health/ready ---"
          curl -sf http://localhost:8001/health/ready | jq .
          echo "--- /health/live ---"
          curl -sf http://localhost:8001/health/live | jq .

      - name: Smoke test — POST alert
        run: |
          HTTP_CODE=$(curl -sf -o /tmp/resp.json -w "%{http_code}" -X POST \
            http://localhost:8001/api/v1/alerts \
            -H "Content-Type: application/json" \
            -d '{"service":"ci-test","severity":"low","message":"smoke test"}')
          [ "$HTTP_CODE" = "201" ] && echo "201 Created" || (echo "Got $HTTP_CODE" && exit 1)
          cat /tmp/resp.json | jq .

      - name: Smoke test — GET alerts
        run: |
          TOTAL=$(curl -sf "http://localhost:8001/api/v1/alerts?service=ci-test" | jq '.total')
          [ "$TOTAL" -ge 1 ] && echo "Found $TOTAL alerts" || (echo "No alerts" && exit 1)

      - name: Verify Prometheus metrics
        run: |
          METRICS=$(curl -sf http://localhost:8001/metrics)
          echo "$METRICS" | grep -q "alerts_received_total" && echo "alerts_received_total present"
          echo "$METRICS" | grep -q "alerts_correlated_total" && echo "alerts_correlated_total present"
          echo "$METRICS" | grep -q "http_requests_total" && echo "http_requests_total present"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Verification failed — rolling back to :prev"
          docker compose down 2>/dev/null || true
          for svc in alert-ingestion incident-management oncall-service notification-service web-ui; do
            docker tag expertmind-${svc}:prev expertmind-${svc}:latest 2>/dev/null || true
          done
          docker compose up -d
          echo "Rollback complete"
