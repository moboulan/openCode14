<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Test Runner — Incident Platform</title>
	<style>
		*,
		*::before,
		*::after {
			box-sizing: border-box;
			margin: 0;
			padding: 0
		}

		:root {
			--bg: #0f172a;
			--surface: #1e293b;
			--surface2: #334155;
			--border: #475569;
			--text: #f1f5f9;
			--text2: #94a3b8;
			--accent: #6366f1;
			--accent2: #818cf8;
			--green: #22c55e;
			--red: #ef4444;
			--amber: #f59e0b;
			--orange: #f97316;
			--blue: #3b82f6;
			--radius: 8px;
			--font: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
		}

		html {
			font-family: var(--font);
			background: var(--bg);
			color: var(--text);
			font-size: 14px;
			line-height: 1.5
		}

		body {
			min-height: 100vh;
			display: flex;
			flex-direction: column
		}

		a {
			color: var(--accent2);
			text-decoration: none
		}

		/* Layout */
		.header {
			background: var(--surface);
			border-bottom: 1px solid var(--border);
			padding: 12px 24px;
			display: flex;
			align-items: center;
			gap: 16px;
			position: sticky;
			top: 0;
			z-index: 50
		}

		.header h1 {
			font-size: 16px;
			font-weight: 600;
			white-space: nowrap
		}

		.header .badge {
			background: var(--accent);
			padding: 2px 10px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: 500
		}

		.header .actions {
			display: flex;
			gap: 8px;
			margin-left: auto
		}

		.main {
			display: grid;
			grid-template-columns: 1fr 380px;
			flex: 1;
			overflow: hidden
		}

		@media(max-width:900px) {
			.main {
				grid-template-columns: 1fr
			}
		}

		.panel-left {
			overflow-y: auto;
			padding: 20px
		}

		.panel-right {
			background: var(--surface);
			border-left: 1px solid var(--border);
			display: flex;
			flex-direction: column;
			overflow: hidden
		}

		@media(max-width:900px) {
			.panel-right {
				border-left: none;
				border-top: 1px solid var(--border);
				max-height: 50vh
			}
		}

		/* Buttons */
		.btn {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 7px 14px;
			border: none;
			border-radius: var(--radius);
			cursor: pointer;
			font: inherit;
			font-size: 12px;
			font-weight: 500;
			transition: all .15s
		}

		.btn-primary {
			background: var(--accent);
			color: #fff
		}

		.btn-primary:hover {
			background: var(--accent2)
		}

		.btn-success {
			background: var(--green);
			color: #000
		}

		.btn-success:hover {
			opacity: .85
		}

		.btn-danger {
			background: var(--red);
			color: #fff
		}

		.btn-danger:hover {
			opacity: .85
		}

		.btn-ghost {
			background: transparent;
			color: var(--text2);
			border: 1px solid var(--border)
		}

		.btn-ghost:hover {
			background: var(--surface2);
			color: var(--text)
		}

		.btn-sm {
			padding: 4px 10px;
			font-size: 11px
		}

		.btn:disabled {
			opacity: .4;
			cursor: not-allowed
		}

		/* Health bar */
		.health-bar {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			padding: 12px 24px;
			background: var(--surface);
			border-bottom: 1px solid var(--border)
		}

		.health-item {
			display: flex;
			align-items: center;
			gap: 5px;
			font-size: 11px;
			color: var(--text2)
		}

		.health-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%
		}

		.health-dot.healthy {
			background: var(--green)
		}

		.health-dot.unhealthy {
			background: var(--red)
		}

		.health-dot.unreachable {
			background: var(--border)
		}

		.health-dot.checking {
			background: var(--amber);
			animation: pulse 1s infinite
		}

		@keyframes pulse {
			50% {
				opacity: .3
			}
		}

		/* Tabs */
		.tabs {
			display: flex;
			border-bottom: 1px solid var(--border);
			padding: 0 20px
		}

		.tab {
			padding: 10px 16px;
			font-size: 12px;
			color: var(--text2);
			cursor: pointer;
			border-bottom: 2px solid transparent;
			font-weight: 500;
			transition: all .15s
		}

		.tab:hover {
			color: var(--text)
		}

		.tab.active {
			color: var(--accent2);
			border-bottom-color: var(--accent2)
		}

		.tab-content {
			display: none
		}

		.tab-content.active {
			display: block
		}

		/* Scenario Cards */
		.category-section {
			margin-bottom: 24px
		}

		.category-title {
			font-size: 13px;
			font-weight: 600;
			color: var(--text2);
			text-transform: uppercase;
			letter-spacing: .06em;
			margin-bottom: 10px;
			display: flex;
			align-items: center;
			gap: 8px
		}

		.category-title::after {
			content: '';
			flex: 1;
			height: 1px;
			background: var(--border)
		}

		.card {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			padding: 12px 14px;
			margin-bottom: 8px;
			display: flex;
			align-items: flex-start;
			gap: 12px;
			transition: border-color .15s
		}

		.card:hover {
			border-color: var(--accent)
		}

		.card-body {
			flex: 1;
			min-width: 0
		}

		.card-header {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 4px
		}

		.card-service {
			font-weight: 600;
			font-size: 13px
		}

		.severity {
			font-size: 10px;
			padding: 2px 8px;
			border-radius: 10px;
			font-weight: 600;
			text-transform: uppercase
		}

		.severity.critical {
			background: #7f1d1d;
			color: #fca5a5
		}

		.severity.high {
			background: #78350f;
			color: #fde68a
		}

		.severity.medium {
			background: #1e3a5f;
			color: #93c5fd
		}

		.severity.low {
			background: #14532d;
			color: #86efac
		}

		.card-msg {
			font-size: 12px;
			color: var(--text2);
			overflow: hidden;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			line-clamp: 2;
			-webkit-box-orient: vertical
		}

		.card-labels {
			display: flex;
			gap: 4px;
			flex-wrap: wrap;
			margin-top: 6px
		}

		.label-tag {
			font-size: 10px;
			background: var(--surface2);
			color: var(--text2);
			padding: 1px 6px;
			border-radius: 4px
		}

		.card-actions {
			display: flex;
			flex-direction: column;
			gap: 4px;
			flex-shrink: 0
		}

		/* Custom form */
		.form-group {
			margin-bottom: 12px
		}

		.form-group label {
			display: block;
			font-size: 11px;
			color: var(--text2);
			margin-bottom: 4px;
			font-weight: 500
		}

		.form-control {
			width: 100%;
			padding: 8px 10px;
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			color: var(--text);
			font: inherit;
			font-size: 12px
		}

		.form-control:focus {
			outline: none;
			border-color: var(--accent)
		}

		select.form-control {
			cursor: pointer
		}

		textarea.form-control {
			resize: vertical;
			min-height: 80px
		}

		/* Feed */
		.feed-header {
			padding: 12px 16px;
			border-bottom: 1px solid var(--border);
			display: flex;
			align-items: center;
			justify-content: space-between
		}

		.feed-header h3 {
			font-size: 13px;
			font-weight: 600
		}

		.feed-count {
			font-size: 11px;
			color: var(--text2)
		}

		.feed-list {
			overflow-y: auto;
			flex: 1;
			padding: 8px
		}

		.feed-item {
			padding: 8px 10px;
			margin-bottom: 6px;
			border-radius: var(--radius);
			background: var(--bg);
			font-size: 11px;
			border-left: 3px solid var(--border);
			transition: all .2s
		}

		.feed-item.sent {
			border-left-color: var(--blue)
		}

		.feed-item.analysed {
			border-left-color: var(--green)
		}

		.feed-item.failed {
			border-left-color: var(--red)
		}

		.feed-item .fi-header {
			display: flex;
			justify-content: space-between;
			margin-bottom: 2px
		}

		.feed-item .fi-service {
			font-weight: 600;
			color: var(--text)
		}

		.feed-item .fi-time {
			color: var(--text2);
			font-size: 10px
		}

		.feed-item .fi-msg {
			color: var(--text2);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis
		}

		.feed-item .fi-ai {
			margin-top: 4px;
			padding: 4px 8px;
			background: var(--surface2);
			border-radius: 4px;
			color: var(--green);
			font-size: 10px
		}

		/* Continuous bar */
		.continuous-bar {
			padding: 10px 20px;
			background: var(--surface);
			border-bottom: 1px solid var(--border);
			display: flex;
			align-items: center;
			gap: 12px;
			flex-wrap: wrap
		}

		.continuous-bar label {
			font-size: 11px;
			color: var(--text2)
		}

		.continuous-bar input[type=number] {
			width: 70px;
			padding: 4px 8px;
			background: var(--bg);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			color: var(--text);
			font: inherit;
			font-size: 12px
		}

		.continuous-indicator {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--red)
		}

		.continuous-indicator.running {
			background: var(--green);
			animation: pulse 1s infinite
		}

		/* Stats row */
		.stats-row {
			display: flex;
			gap: 12px;
			padding: 12px 0;
			flex-wrap: wrap
		}

		.stat-item {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			padding: 12px 16px;
			flex: 1;
			min-width: 100px;
			text-align: center
		}

		.stat-val {
			font-size: 24px;
			font-weight: 700
		}

		.stat-val.green {
			color: var(--green)
		}

		.stat-val.red {
			color: var(--red)
		}

		.stat-val.blue {
			color: var(--blue)
		}

		.stat-val.amber {
			color: var(--amber)
		}

		.stat-label {
			font-size: 10px;
			color: var(--text2);
			text-transform: uppercase;
			letter-spacing: .04em;
			margin-top: 2px
		}

		/* Spinner */
		.spinner {
			width: 14px;
			height: 14px;
			border: 2px solid rgba(255, 255, 255, .2);
			border-top-color: #fff;
			border-radius: 50%;
			animation: spin .6s linear infinite;
			display: inline-block
		}

		@keyframes spin {
			to {
				transform: rotate(360deg)
			}
		}

		/* Toast */
		.toast-container {
			position: fixed;
			bottom: 20px;
			right: 20px;
			z-index: 100;
			display: flex;
			flex-direction: column;
			gap: 8px
		}

		.toast {
			padding: 10px 16px;
			border-radius: var(--radius);
			font-size: 12px;
			color: #fff;
			animation: toast-in .3s ease
		}

		.toast.success {
			background: var(--green)
		}

		.toast.error {
			background: var(--red)
		}

		.toast.info {
			background: var(--blue)
		}

		@keyframes toast-in {
			from {
				opacity: 0;
				transform: translateY(10px)
			}

			to {
				opacity: 1;
				transform: translateY(0)
			}
		}
	</style>
</head>

<body>

	<!-- Header -->
	<div class="header">
		<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<path
				d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
		</svg>
		<h1>Test Runner</h1>
		<span class="badge" id="scenarioCount">15 scenarios</span>
		<div class="actions">
			<button class="btn btn-ghost btn-sm" onclick="checkHealth()">
				<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M22 12h-4l-3 9L9 3l-3 9H2" />
				</svg>
				Health Check
			</button>
			<button class="btn btn-ghost btn-sm" onclick="setupOnCall()">
				<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
					<circle cx="9" cy="7" r="4" />
					<path d="M23 21v-2a4 4 0 0 0-3-3.87" />
					<path d="M16 3.13a4 4 0 0 1 0 7.75" />
				</svg>
				Setup On-Call
			</button>
			<button class="btn btn-success btn-sm" id="btnSendAll" onclick="sendAll()">
				<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M22 2L11 13" />
					<path d="M22 2l-7 20-4-9-9-4 20-7z" />
				</svg>
				Send All
			</button>
		</div>
	</div>

	<!-- Health bar -->
	<div class="health-bar" id="healthBar">
		<div class="health-item">
			<div class="health-dot unreachable" id="hd-alert-ingestion"></div>alert-ingestion
		</div>
		<div class="health-item">
			<div class="health-dot unreachable" id="hd-incident-management"></div>incident-management
		</div>
		<div class="health-item">
			<div class="health-dot unreachable" id="hd-oncall-service"></div>oncall-service
		</div>
		<div class="health-item">
			<div class="health-dot unreachable" id="hd-notification-service"></div>notification-service
		</div>
		<div class="health-item">
			<div class="health-dot unreachable" id="hd-ai-analysis"></div>ai-analysis
		</div>
	</div>

	<!-- Continuous bar -->
	<div class="continuous-bar">
		<span class="continuous-indicator" id="contIndicator"></span>
		<label>Continuous Mode</label>
		<label>Interval (s):</label>
		<input type="number" id="contInterval" value="15" min="3" max="300">
		<button class="btn btn-primary btn-sm" id="btnContStart" onclick="toggleContinuous()">Start</button>
		<span id="contStatus" style="font-size:11px;color:var(--text2)">Stopped</span>
	</div>

	<!-- Main -->
	<div class="main">
		<!-- Left: Tabs + content -->
		<div class="panel-left">
			<!-- Stats -->
			<div class="stats-row" id="statsRow">
				<div class="stat-item">
					<div class="stat-val blue" id="statSent">0</div>
					<div class="stat-label">Sent</div>
				</div>
				<div class="stat-item">
					<div class="stat-val green" id="statAnalysed">0</div>
					<div class="stat-label">AI Analysed</div>
				</div>
				<div class="stat-item">
					<div class="stat-val red" id="statFailed">0</div>
					<div class="stat-label">Failed</div>
				</div>
				<div class="stat-item">
					<div class="stat-val amber" id="statTotal">0</div>
					<div class="stat-label">Total</div>
				</div>
			</div>

			<!-- Tabs -->
			<div class="tabs">
				<div class="tab active" onclick="switchTab('scenarios')">Scenarios</div>
				<div class="tab" onclick="switchTab('custom')">Custom Alert</div>
			</div>

			<!-- Tab: Scenarios -->
			<div class="tab-content active" id="tab-scenarios" style="padding-top:16px">
				<div id="scenarioList">Loading...</div>
			</div>

			<!-- Tab: Custom Alert -->
			<div class="tab-content" id="tab-custom" style="padding-top:16px">
				<div class="form-group">
					<label>Service</label>
					<input class="form-control" id="customService" placeholder="my-service">
				</div>
				<div class="form-group">
					<label>Severity</label>
					<select class="form-control" id="customSeverity">
						<option value="critical">Critical</option>
						<option value="high">High</option>
						<option value="medium" selected>Medium</option>
						<option value="low">Low</option>
					</select>
				</div>
				<div class="form-group">
					<label>Message</label>
					<textarea class="form-control" id="customMessage" placeholder="Describe the alert..."></textarea>
				</div>
				<div class="form-group">
					<label>Labels (JSON, optional)</label>
					<input class="form-control" id="customLabels" placeholder='{"env":"production"}'>
				</div>
				<button class="btn btn-primary" onclick="sendCustom()">Send Custom Alert</button>
			</div>
		</div>

		<!-- Right: Live Feed -->
		<div class="panel-right">
			<div class="feed-header">
				<h3>Live Feed</h3>
				<div>
					<span class="feed-count" id="feedCount">0 events</span>
					<button class="btn btn-ghost btn-sm" style="margin-left:8px" onclick="clearHistory()">Clear</button>
				</div>
			</div>
			<div class="feed-list" id="feedList">
				<div style="text-align:center;padding:40px;color:var(--text2);font-size:12px">
					No events yet. Send an alert to get started.
				</div>
			</div>
		</div>
	</div>

	<div class="toast-container" id="toastContainer"></div>

	<script>
		const API = window.location.origin;
		let ws = null;
		let stats = { sent: 0, analysed: 0, failed: 0, total: 0 };
		let continuousRunning = false;

		// ── Helpers ──
		function $(id) { return document.getElementById(id) }
		function toast(msg, type = 'info') {
			const el = document.createElement('div');
			el.className = 'toast ' + type;
			el.textContent = msg;
			$('toastContainer').appendChild(el);
			setTimeout(() => el.remove(), 3500);
		}
		async function api(path, opts = {}) {
			const res = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
			return res.json();
		}
		function timeStr(iso) {
			if (!iso) return '';
			const d = new Date(iso);
			return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
		}

		// ── Tabs ──
		function switchTab(name) {
			document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase().includes(name)));
			document.querySelectorAll('.tab-content').forEach(t => t.classList.toggle('active', t.id === 'tab-' + name));
		}

		// ── Health ──
		async function checkHealth() {
			document.querySelectorAll('.health-dot').forEach(d => { d.className = 'health-dot checking' });
			try {
				const h = await api('/api/health-check');
				for (const [name, info] of Object.entries(h)) {
					const dot = $('hd-' + name);
					if (dot) dot.className = 'health-dot ' + (info.status || 'unreachable');
				}
				toast('Health check complete', 'success');
			} catch (e) {
				toast('Health check failed', 'error');
			}
		}

		// ── Scenarios ──
		async function loadScenarios() {
			try {
				const data = await api('/api/scenarios');
				$('scenarioCount').textContent = data.total + ' scenarios';
				let html = '';
				for (const [cat, items] of Object.entries(data.categories)) {
					html += `<div class="category-section"><div class="category-title">${cat} (${items.length})</div>`;
					for (const s of items) {
						const labels = Object.entries(s.labels || {}).map(([k, v]) => `<span class="label-tag">${k}=${v}</span>`).join('');
						html += `<div class="card" id="card-${s.id}">
          <div class="card-body">
            <div class="card-header">
              <span class="card-service">${s.service}</span>
              <span class="severity ${s.severity}">${s.severity}</span>
            </div>
            <div class="card-msg">${s.message}</div>
            <div class="card-labels">${labels}</div>
          </div>
          <div class="card-actions">
            <button class="btn btn-primary btn-sm" onclick="sendOne('${s.id}')">Send</button>
          </div>
        </div>`;
					}
					html += `</div>`;
				}
				$('scenarioList').innerHTML = html;
			} catch (e) {
				$('scenarioList').innerHTML = '<p style="color:var(--red)">Failed to load scenarios</p>';
			}
		}

		// ── Send ──
		async function sendOne(id) {
			const card = $('card-' + id);
			const btn = card?.querySelector('.btn');
			if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>'; }
			try {
				const r = await api('/api/send/' + id, { method: 'POST' });
				if (r.error) { toast(r.error, 'error'); }
			} catch (e) { toast('Send failed', 'error'); }
			if (btn) { btn.disabled = false; btn.textContent = 'Send'; }
		}

		async function sendAll() {
			const btn = $('btnSendAll');
			btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Sending...';
			try {
				const r = await api('/api/send-all', { method: 'POST' });
				toast(`Done! ${r.sent} sent, ${r.analysed} analysed, ${r.failed} failed`, 'success');
			} catch (e) { toast('Send all failed', 'error'); }
			btn.disabled = false; btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Send All';
		}

		async function sendCustom() {
			const service = $('customService').value.trim();
			const severity = $('customSeverity').value;
			const message = $('customMessage').value.trim();
			let labels = {};
			try { labels = JSON.parse($('customLabels').value || '{}'); } catch (e) { }
			if (!service || !message) { toast('Service and message are required', 'error'); return; }
			try {
				await api('/api/send-custom', { method: 'POST', body: JSON.stringify({ service, severity, message, labels }) });
				toast('Custom alert sent', 'success');
			} catch (e) { toast('Failed to send custom alert', 'error'); }
		}

		// ── On-Call ──
		async function setupOnCall() {
			try {
				const r = await api('/api/setup-oncall', { method: 'POST' });
				toast(`On-call: ${r.length} teams configured`, 'success');
			} catch (e) { toast('On-call setup failed', 'error'); }
		}

		// ── Continuous ──
		async function toggleContinuous() {
			if (continuousRunning) {
				await api('/api/continuous/stop', { method: 'POST' });
				continuousRunning = false;
				$('btnContStart').textContent = 'Start';
				$('btnContStart').className = 'btn btn-primary btn-sm';
				$('contIndicator').classList.remove('running');
				$('contStatus').textContent = 'Stopped';
			} else {
				const interval = parseInt($('contInterval').value) || 15;
				await api('/api/continuous/start', { method: 'POST', body: JSON.stringify({ interval, categories: [] }) });
				continuousRunning = true;
				$('btnContStart').textContent = 'Stop';
				$('btnContStart').className = 'btn btn-danger btn-sm';
				$('contIndicator').classList.add('running');
				$('contStatus').textContent = 'Running (every ' + interval + 's)';
			}
		}

		// ── Feed ──
		function addFeedItem(data) {
			const list = $('feedList');
			if (list.querySelector('div[style]')) list.innerHTML = '';
			const severity = data.severity || 'medium';
			const aiHtml = data.ai_suggestions?.length ?
				`<div class="fi-ai">AI: ${data.ai_suggestions[0].root_cause || data.ai_suggestions[0]}</div>` : '';
			const el = document.createElement('div');
			el.className = 'feed-item ' + (data.status || 'sent');
			el.innerHTML = `<div class="fi-header"><span class="fi-service">${data.service || '?'} <span class="severity ${severity}" style="font-size:9px">${severity}</span></span><span class="fi-time">${timeStr(data.timestamp)}</span></div><div class="fi-msg">${data.message || ''}</div>${aiHtml}`;
			list.prepend(el);

			// Update stats
			stats.total++;
			if (data.status === 'analysed') stats.analysed++;
			else if (data.status === 'sent') stats.sent++;
			else if (data.status === 'failed') stats.failed++;
			else stats.sent++;
			$('statSent').textContent = stats.sent;
			$('statAnalysed').textContent = stats.analysed;
			$('statFailed').textContent = stats.failed;
			$('statTotal').textContent = stats.total;
			$('feedCount').textContent = stats.total + ' events';
		}

		// ── Clear History ──
		async function clearHistory() {
			await api('/api/history', { method: 'DELETE' });
			$('feedList').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text2);font-size:12px">No events yet. Send an alert to get started.</div>';
			stats = { sent: 0, analysed: 0, failed: 0, total: 0 };
			$('statSent').textContent = '0'; $('statAnalysed').textContent = '0';
			$('statFailed').textContent = '0'; $('statTotal').textContent = '0';
			$('feedCount').textContent = '0 events';
		}

		// ── Load existing history ──
		async function loadHistory() {
			try {
				const items = await api('/api/history');
				if (Array.isArray(items)) {
					for (const item of items.reverse()) addFeedItem(item);
				}
			} catch (e) { }
		}

		// ── WebSocket ──
		function connectWS() {
			const proto = location.protocol === 'https:' ? 'wss' : 'ws';
			// When accessed via nginx proxy, websocket URL needs to use /api/test-runner/ws
			// When accessed directly, use /ws
			const wsUrl = `${proto}://${location.host}/ws`;
			ws = new WebSocket(wsUrl);
			ws.onmessage = (e) => {
				try {
					const msg = JSON.parse(e.data);
					if (msg.type === 'result') addFeedItem(msg.data);
					if (msg.type === 'continuous_stopped') {
						continuousRunning = false;
						$('btnContStart').textContent = 'Start';
						$('btnContStart').className = 'btn btn-primary btn-sm';
						$('contIndicator').classList.remove('running');
						$('contStatus').textContent = 'Stopped (' + msg.total + ' sent)';
					}
				} catch (err) { }
			};
			ws.onclose = () => setTimeout(connectWS, 3000);
			ws.onerror = () => ws.close();
		}

		// ── Continuous status check ──
		async function checkContinuousStatus() {
			try {
				const r = await api('/api/continuous/status');
				if (r.running) {
					continuousRunning = true;
					$('btnContStart').textContent = 'Stop';
					$('btnContStart').className = 'btn btn-danger btn-sm';
					$('contIndicator').classList.add('running');
					$('contStatus').textContent = 'Running';
				}
			} catch (e) { }
		}

		// ── Init ──
		document.addEventListener('DOMContentLoaded', () => {
			loadScenarios();
			checkHealth();
			loadHistory();
			connectWS();
			checkContinuousStatus();
			// Auto health-check every 30s
			setInterval(checkHealth, 30000);
		});
	</script>
</body>

</html>